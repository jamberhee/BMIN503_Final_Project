---
title: "Your Title"
subtitle: "BMIN503/EPID600 Final Project"
author: "Amber Rhee"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required. I added a new sentence

## Overview {#sec-overview}

Give a brief a description of your project and its goal(s), what data you are using to complete it, and what two faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

For my final project, I am using data from the 2023 NHIS's (Sample Adult) communication core and chronic pain content to examine the association between one's communication ability (which can, e.g., translate into ability to communicate symptoms to providers) and high impact pain (pain defined as significant enough to limit daily activities). John Farrar, MD, PhD has helped me consider potential confounders and effect modifiers that may affect the association between my variables of interest, while Adam Naj, PhD has helped me decide how I want to model the actual data in my analyis.

[Final Project Repo](https://github.com/jamberhee/BMIN503_Final_Project)

## Introduction {#sec-introduction}

Describe the problem addressed, its significance, and some background to motivate the problem. This should extend what is in the @sec-overview.

Chronic pain is a major public health concern in the U.S., with high prevalence across sociodemographic groups \[1\]. As a subjective experience, proper communication of pain and relevant symptoms from patient to healthcare provider and belief of patient-report by providers are essential for adequate management \[2-4\]. Consequently, disparities in pain management are significant \[5\].

References

1.  Rikard SM, Strahan AE, Schmit KM, Guy GP Jr.. Chronic Pain Among Adults — United States, 2019–2021. MMWR Morb Mortal Wkly Rep 2023;72:379–385. DOI: http://dx.doi.org/10.15585/mmwr.mm7215a1
2.  Sabater-Gárriz Á, Molina-Mula J, Montoya P, Riquelme I. Pain assessment tools in adults with communication disorders: systematic review and meta-analysis. BMC Neurol. 2024 Feb 17;24(1):66. doi: 10.1186/s12883-024-03539-w. PMID: 38368314; PMCID: PMC10873938.
3.  Brown VL, James A, Hunleth J, Bradley CS, Farrar JT, Gupta P, Lai HH, Lowder JL, Moldwin R, Rodriguez LV, Yang CC, Sutcliffe S. Believing women: a qualitative exploration of provider disbelief and pain dismissal among women with interstitial cystitis/bladder pain syndrome from the MAPP research network. Int Urogynecol J. 2024 Jan;35(1):139-148. doi: 10.1007/s00192-023-05677-0. Epub 2023 Nov 22. PMID: 37991567; PMCID: PMC11019919.
4.  Tosas, M.R. The downgrading of pain sufferers’ credibility. Philos Ethics Humanit Med 16, 8 (2021). https://doi.org/10.1186/s13010-021-00105-x
5.  Nguyen LH, Dawson JE, Brooks M, Khan JS, Telusca N. Disparities in Pain Management. Anesthesiol Clin. 2023 Jun;41(2):471-488. doi: 10.1016/j.anclin.2023.03.008. PMID: 37245951.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

Pain is often defined by a biopsychosocial model, meaning physiological, psychological, and social factors all play an integral role, interacting with each other to create pain outcomes \[6\]. Attempting to study pain at the population level is, thus, an intricate task. I could benefit to receive inputs from general practitioners, pain specialists, psychologists, and even behavioral and social scientists to gain insights on my research question but also from epidemiologists to learn to how I can explore this question in a nationally-representative survey and what considerations I have to make in the process. Dr. John Farrar, as both a clinical epidemiologist and neurologist, (will continue to add as I meet him again). Dr. Adam Naj, (will continue to add as I meet him again).

References

6.  Meints SM, Edwards RR. Evaluating psychosocial contributions to chronic pain outcomes. Prog Neuropsychopharmacol Biol Psychiatry. 2018 Dec 20;87(Pt B):168-182. doi: 10.1016/j.pnpbp.2018.01.017. Epub 2018 Jan 31. PMID: 29408484; PMCID: PMC6067990.

## Methods {#sec-methods}

Describe the data used and general methodological approach used to address the problem described in the @sec-introduction. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

I used "Sample Adult" data from the 2023 National Health Interview Survey (NHIS). Estimates from the NHIS are designed to be representative of the noninstitutionalized civilian population of the U.S.

> Install and load libraries

```{r}
# install.packages("tidyverse)
# install.packages("survey")

library(tidyverse)
library(survey)
library(dagitty)
library(table1)
library(corrplot)
library(mice)
library(mitools)
```

> Load data

```{r}
## loaded according to recommended/provided code from NHIS
### prevents errors in reading in data file due to missingness in data
adult2023 <- read_csv("adult23.csv", guess_max = 29522)

## https://ftp.cdc.gov/pub/Health_Statistics/NCHS/Datasets/NHIS/2023/adult23csv.zip

```

Communication difficulty was determined by the question, "Using your usual language, do you have difficulty communicating, for example, understanding or being understood?" Participants could respond, "No difficulty", "Some difficulty", "A lot of difficulty", or "Cannot do at all." Due to small sample size, I collapsed the "A lot of difficulty" and "Cannot do at all" participants into a single group.

Participants were asked, "In the past three months, how often did you have pain?", to which they could answer, "Never," "Some days," "Most days," or "Every day." Only those who reported any pain to this question were asked the follow question: "Over the past three months, how often did your pain limit your life or work?" High impact pain was defined as pain that limited life or work "Most days" or "Every day." Participants who responded "Never" or "Some days" or reported no pain in the last three months were classified as individuals without high impact pain.

> Initial inspection of data for sample size

```{r}
## check unique adults in dataset
### 29522 adults--one row per participant
length(unique(adult2023$HHX))

## change missing to NA
## convert comm difficulty variable to factor
## collapse lots + completely due to small cell size
adult2023 <- adult2023 %>% 
  mutate(COMDIFF_A = as.factor(case_when(adult2023$COMDIFF_A > 4 ~ NA,
                               adult2023$COMDIFF_A == 4 |
                                 adult2023$COMDIFF_A == 3 ~ "Lots or Completely",
                               adult2023$COMDIFF_A == 2 ~ "Some",
                               adult2023$COMDIFF_A == 1 ~ "None")))
adult2023$COMDIFF_A <- factor(adult2023$COMDIFF_A, 
                              levels = c("None","Some","Lots or Completely"))
table(adult2023$COMDIFF_A,useNA = "always")

## change missing to NA
## convert high impact pain variable to factor
adult2023$PAIWKLM3M_A <- ifelse(adult2023$PAIWKLM3M_A > 4, NA, adult2023$PAIWKLM3M_A)
adult2023$PAIWKLM3M_A <- factor(adult2023$PAIWKLM3M_A,
                                labels = c("Never","Some","Most","Every"))
table(adult2023$PAIWKLM3M_A)

## create pain binary variable for outcome
adult2023 <- adult2023 |>
  mutate(hip_binary = ifelse(adult2023$PAIWKLM3M_A == "Never" |
                               adult2023$PAIWKLM3M_A == "Some", 0, 1))

## examine outcome for sample size
table(adult2023$hip_binary)
prop.table(table(adult2023$COMDIFF_A,adult2023$hip_binary),2)
```

> Examine sampling

```{r}
## rename variables of interest
## 7 participants missing exposure
## cannot filter out individuals because
### all of the strata need to be used in the calculation of the standard error
data <- adult2023 %>% 
  as.data.frame() %>% 
  rename(id = HHX,
         strata = PSTRAT,
         sweight = WTFA_A,
         psu = PPSU,
         comdiff = COMDIFF_A,
         pain = PAIFRQ3M_A,
         hip = PAIWKLM3M_A)

## if no pain, no hip also
data <- data %>% 
  mutate(hip = ifelse(pain == 1, 1, hip)) %>%
  mutate(hip_binary = ifelse(pain == 1, 0, hip_binary))
weighted_data_test <-svydesign(id=~psu, weights=~sweight,
                          strata=~strata, nest=TRUE,
                          data = data)

summary(weighted_data_test)

svytable(~comdiff+hip, weighted_data_test)
svytable(~comdiff+hip_binary, weighted_data_test)
```

Confounders and effect modifiers were identified a priori from the literature and discussed with Dr. Farrar. My hypothetical causal framework is depicted in a directed acyclic graph (DAG) below. Of my proposed confounders, 2 were not captured in the data--autism and stress. They cannot, thus, be controlled for the in the analysis. I used "use of a hearing aid" as a proxy for hearing loss. All conditions (stroke, dementia, fatigue, anxiety) are ever-diagnoses.

> Identify confounders

```{r}
knitr::include_graphics("dag_1122.png")
```

Due to a high level of missingness (~30%), I decided to stratify by primary language in a subanalysis instead of the entire analytic population.

> Finalize dataset before weighting

```{r}
## rename variables of interest (confounders, effect modifiers)
## isolate variables i want to work with
## 932 (3% of total sample) missing outcome
data <- data %>% 
  rename(lang_other = LANGHM_A,
         lang_tv = LANGMED_A,
         lang_doc = LANGDOC_A,
         lang_soc = LANGSOC_A,
         race = HISPALLP_A,
         age = AGEP_A,
         hearing = HEARAID_A,
         dementia = DEMENEV_A,
         fatigue = CFSEV_A,
         anxiety = ANXEV_A,
         sex = SEX_A,
         stroke = STREV_A) %>% 
  select(id,strata,sweight,psu,comdiff,pain,hip,hip_binary,
         lang_other,lang_tv,lang_doc,lang_soc,race,age,
         hearing,dementia,fatigue,anxiety,sex,stroke)

summary(data)

## make na values na
cols <- c(6,9:12,15:20)
data <- data %>% 
  mutate(across(all_of(cols), ~ if_else(.x >= 7, NA_real_, .x))) %>% 
  mutate(age = ifelse(age > 85, NA, age))

## check for correlation between conditions
vars <- data[, c(15:18,20)]
vars01 <- as.tibble(ifelse(vars == 2, 1, 0))
cor_mat <- cor(vars01,use = "pairwise.complete.obs")
corrplot(cor_mat, method = "color",
         type = "upper", tl.col = "black", tl.cex = 0.7)

## convert pain var to factors
data[,6:7] <- lapply(data[,6:7], factor,
                       levels = c(1:4),
                       labels = c("Never", "Some", "Most", "Every"))

## convert language vars to factors
data[,10:12] <- lapply(data[,10:12], factor,
                       levels = c(1,2),
                       labels = c("English", "Other language"))

## convert y/n vars to factors
data[,c(9,15:18,20)] <- lapply(data[,c(9,15:18,20)], factor,
                       levels = c(1,2),
                       labels = c("Yes", "No"))

data[,c(9,15:18,20)] <- lapply(data[,c(9,15:18,20)], relevel,
                            ref = "No")

## convert remaining vars to factors                    
data <- data %>% 
  mutate(id = factor(id),
         hip_binary = factor(hip_binary,
                             levels = c(0,1),
                             labels = c("No","Yes")),
         race = factor(race,
                       levels = c(1:7),
                       labels = c("Hispanic","NH White","NH Black",
                                  "NH Asian", "NH AIAN only", "NH AIAN and other",
                                  "Other/Multi")),
         sex = factor(sex,
                      levels = c(1,2),
                      labels = c("Male","Female")))
         
prop.table(table(data$lang_other, useNA = "always")) ## fairly high level of missingness
## maybe do stratification as a sub-analysis

summary(data)

# save(data, file = "data.Rda")
load("data.Rda")
```

For all covariate variables, missing values were imputed using multiple imputation by chained equations (MICE).

> MICE

```{r}
## remove test to clear up environment
rm(weighted_data_test)

## prepare for multiple imputation followed by deletion of imputed outcomes
data_main <- data %>% 
  select(-c(6:7,9:12))

## check missingness pattern
md.pattern(data_main)

## run imputation, 5 iterations
imp <- mice(data_main, print=F, maxit = 5, seed = 1234)

## imputation = very computationally intensive so comment out
# save(imp, file="imp.Rda")
load("imp.Rda")

# check for convergence
plot(imp)
summary(imp)
```

Participants missing the exposure, outcome, or both variables were excluded from the calculation of the estimates. They remain included for the calculation of the standard errors. Imputed datasets were weighted using the R package survey 4.4-8 according to the weights provided by the NHIS dataset. 

> Apply weighting+subsetting

```{r}
impdata <- mice::complete(imp, action = "all")

data.list <- vector("list", 5)
# subset the data without Y and A's that had missing values
# and record those subset data
for (i in 1:5) {
  analytic.i <- impdata[[i]]
  analytic.i$miss <- 1
  analytic.i$miss[analytic.i$id %in%
                    subset(data,complete.cases(comdiff,hip_binary))$id] <- 0
  data.list[[i]] <- analytic.i
}
data.list 


require(survey)
fit.list1 <- vector("list", 5)
fit.list2 <- vector("list", 5)
fit.list3 <- vector("list", 5)
for (i in 1:5) {
  analytic.i <- data.list[[i]]
  # assigning survey features = 1
  weighted_data <- svydesign(id=~psu, weights=~sweight,
                          strata=~strata, nest=TRUE,
                          data = analytic.i)
  weighted_complete <- subset(weighted_data, miss == 0)
  fit1 <- svyglm(hip_binary~comdiff,
                  family=quasibinomial,
                  design=weighted_complete, na.action = na.omit)
  fit.list1[[i]] <-  fit1
  fit2 <- svyglm(hip_binary~comdiff+sex+race+age,
                  family=quasibinomial,
                  design=weighted_complete, na.action = na.omit)
  fit.list2[[i]] <-  fit2
  fit3 <- svyglm(hip_binary~comdiff+sex+race+age+hearing+dementia+fatigue+anxiety+stroke,
                  family=quasibinomial,
                  design=weighted_complete, na.action = na.omit)
  fit.list3[[i]] <-  fit3
}


require(mitools)
fit.list <- list(fit.list1,fit.list2,fit.list3)
pooled.estimates <- lapply(fit.list,MIcombine)
pooled.estimates

lapply(pooled.estimates, summary, logeffect=T)

summary(pooled.estimates[[3]], logeffect=T) %>% View()
## apply weights

## subset data to only include participants with exposure and outcome data

## representative of 258237552 individuals to 249862610 individuals weighted
sum(weights(weighted_data))
sum(weights(weighted_complete))

```

> Inspection of weighted data

```{r}
## look at exposure x outcome
svytable(~comdiff+hip_binary, weighted_complete)

## distribution of continuous var
svyhist(~age, weighted_complete, probability = FALSE)
```

I conducted a logistic regression of communication difficulty on high impact pain, adjusted for sex, race/ethnicity, age (continuous), hearing loss, dementia, fatigue, anxiety, and stroke. All confounders were included as factors, unless otherwise specified.

> Run analysis

```{r}
##need to figure out how i want to handle missingness

## base logistic regression
logit1 <- (svyglm(hip_binary~comdiff, family=quasibinomial,
                  design=weighted_complete, na.action = na.omit))
summary(logit1)

## add demographic confounders
logit2 <- (svyglm(hip_binary~comdiff+sex+race+age, family=quasibinomial,
                  design=weighted_complete, na.action = na.omit))
summary(logit2)

## add comorbidity confounders
logit3 <- (svyglm(hip_binary~comdiff+sex+race+age+hearing+dementia+fatigue+anxiety+stroke,
                  family=quasibinomial,
                  design=weighted_complete, na.action = na.omit))
summary(logit3)
```

As a subanalysis,

> Run subanalysis

```{r}
ini  <- mice(data, maxit=0)
pred <- ini$pred

# Don’t let the outcome predict its own imputation model
pred["outcome", "outcome"] <- 0

# Often: don't let outcome predict exposure in a causal model
pred["exposure", "outcome"] <- 0

imp <- mice(data, pred=pred, m=20)

fits <- with(imp, svyglm(Y ~ X + covariates, design = survey_design))
summary(pool(fits))

```

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

# Study Population

Table 1 shows selected characteristics of the U.S. adults examined in our analysis.

```{r}
table1_data <- data
label(table1_data$sex) <- "Sex"
label(table1_data$hip_binary) <- "High Impact Pain"
label(table1_data$race) <- "Race and Ethnicity"
label(table1_data$age) <- "Age"
label(table1_data$comdiff) <- "Difficulty Communicating"
label(table1_data$dementia) <- "Dementia"
label(table1_data$hearing) <- "Hearing"
label(table1_data$fatigue) <- "Fatigue"
label(table1_data$anxiety) <- "Anxiety"
table1 <- table1(~ sex + age + race + comdiff + dementia +
                   hearing + fatigue + anxiety| hip_binary,
                 data=table1_data)
table1 ## need to clean up + label. weighted vs numbers?

sum(weights(weighted_data))
```

```{r}
## main analysis output
summary(logit3)

results <- as.data.frame(coef(summary(logit3))[2:3,],keep.rownames = "outcome")
results
```

## Conclusion

This the conclusion. The @sec-results can be invoked here.
